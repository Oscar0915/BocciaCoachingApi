<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/BocciaCoaching/Repositories/UserRepository.cs">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/BocciaCoaching/Repositories/UserRepository.cs" />
              <option name="originalContent" value="﻿using BocciaCoaching.Data;&#10;using BocciaCoaching.Models.DTO.Auth;&#10;using BocciaCoaching.Models.DTO.General;&#10;using BocciaCoaching.Models.DTO.User;&#10;using BocciaCoaching.Models.DTO.User.Atlhete;&#10;using BocciaCoaching.Models.Entities;&#10;using BocciaCoaching.Repositories.Interfaces;&#10;using Microsoft.EntityFrameworkCore;&#10;&#10;namespace BocciaCoaching.Repositories&#10;{&#10;    public class UserRepository(ApplicationDbContext context) : IUserRepository&#10;    {&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; AddUser(InfoUserRegisterDto userDto)&#10;        {&#10;            try&#10;            {&#10;                string passwordHash = BCrypt.Net.BCrypt.HashPassword(userDto.Password);&#10;&#10;                var user = new User&#10;                {&#10;                    Email = userDto.Email,&#10;                    Password = passwordHash,&#10;                    Country = userDto.Region,&#10;                    FirstName = &quot;Name&quot;,&#10;                };&#10;&#10;                await context.Users.AddAsync(user);&#10;                await context.SaveChangesAsync();&#10;&#10;                var athlete = new UserRol&#10;                {&#10;                    RolId = userDto.Rol,&#10;                    UserId = user.UserId&#10;                };&#10;&#10;                await context.UserRoles.AddAsync(athlete);&#10;                await context.SaveChangesAsync();&#10;&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Usuario creado exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en AddUser: {ex.Message}&quot;);&#10;                return ResponseContract&lt;bool&gt;.Fail($&quot;Error al crear usuario: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;IEnumerable&lt;InfoBasicUserDto&gt;&gt;&gt; GetAllAsync()&#10;        {&#10;            try&#10;            {&#10;                var usersData = await context.Users.ToListAsync();&#10;                var infoUser = usersData.Select(u =&gt; new InfoBasicUserDto&#10;                {&#10;                    Name = u.FirstName&#10;                }).ToList();&#10;&#10;                return ResponseContract&lt;IEnumerable&lt;InfoBasicUserDto&gt;&gt;.Ok(infoUser, &quot;Usuarios obtenidos exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en GetAllAsync: {ex.Message}&quot;);&#10;                return ResponseContract&lt;IEnumerable&lt;InfoBasicUserDto&gt;&gt;.Fail($&quot;Error al obtener usuarios: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;InfoBasicUserDto&gt;&gt; GetByIdAsync(int id)&#10;        {&#10;            try&#10;            {&#10;                var user = await context.Users.FindAsync(id);&#10;                &#10;                if (user == null)&#10;                    return ResponseContract&lt;InfoBasicUserDto&gt;.Fail(&quot;Usuario no encontrado&quot;);&#10;&#10;                var infoUser = new InfoBasicUserDto&#10;                {&#10;                    Name = user.FirstName&#10;                };&#10;&#10;                return ResponseContract&lt;InfoBasicUserDto&gt;.Ok(infoUser, &quot;Usuario obtenido exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en GetByIdAsync: {ex.Message}&quot;);&#10;                return ResponseContract&lt;InfoBasicUserDto&gt;.Fail($&quot;Error al obtener usuario: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        private async Task&lt;User?&gt; GetUserByEmailAsync(string email)&#10;        {&#10;            return await context.Users&#10;     .Select(u =&gt; new User&#10;     {&#10;         UserId = u.UserId,&#10;         Email = u.Email ?? string.Empty,&#10;         Password = u.Password ?? string.Empty,&#10;         FirstName = u.FirstName ?? string.Empty,&#10;         LastName = u.LastName ?? string.Empty&#10;     })&#10;     .FirstOrDefaultAsync(u =&gt; u.Email == email);&#10;        }&#10;&#10;        /// &lt;summary&gt;&#10;        /// Método para iniciar sesión &#10;        /// &lt;/summary&gt;&#10;        /// &lt;returns&gt;&lt;/returns&gt;&#10;        public async Task&lt;ResponseContract&lt;LoginResponseDto&gt;&gt; Login(LoginRequestDto loginDto)&#10;        {&#10;            try&#10;            {&#10;                var user = await GetUserByEmailAsync(loginDto.Email);&#10;                if (user == null) &#10;                    return ResponseContract&lt;LoginResponseDto&gt;.Fail(&quot;Usuario no encontrado&quot;);&#10;&#10;                // Verificar contraseña&#10;                bool validPassword = BCrypt.Net.BCrypt.Verify(loginDto.Password, user.Password);&#10;                if (!validPassword) &#10;                    return ResponseContract&lt;LoginResponseDto&gt;.Fail(&quot;Contraseña incorrecta&quot;);&#10;&#10;                var roles = context.UserRoles.Where(x =&gt; x.UserId == user.UserId).ToList();&#10;&#10;                if (roles.Count == 0)&#10;                    return ResponseContract&lt;LoginResponseDto&gt;.Fail(&quot;Usuario sin roles asignados&quot;);&#10;&#10;                // Generar respuesta&#10;                var response = new LoginResponseDto&#10;                {&#10;                    UserId = user.UserId,&#10;                    Email = user.Email,&#10;                    RolId = roles[0].RolId&#10;                };&#10;&#10;                return ResponseContract&lt;LoginResponseDto&gt;.Ok(response, &quot;Login exitoso&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en Login: {ex.Message}&quot;);&#10;                return ResponseContract&lt;LoginResponseDto&gt;.Fail($&quot;Error al iniciar sesión: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        /// &lt;summary&gt;&#10;        /// Registrar atleta&#10;        /// &lt;/summary&gt;&#10;        /// &lt;param name=&quot;atlheteInfoSave&quot;&gt;&lt;/param&gt;&#10;        /// &lt;returns&gt;&lt;/returns&gt;&#10;        public async Task&lt;ResponseContract&lt;int&gt;&gt; RegistrarAtleta(AtlheteInfoSave atlheteInfoSave)&#10;        {&#10;            try&#10;            {&#10;                // Contraseña por defecto&#10;                string defaultPassword = &quot;boccia123&quot;;&#10;                string passwordHash = BCrypt.Net.BCrypt.HashPassword(defaultPassword);&#10;&#10;                var user = new User&#10;                {&#10;                    FirstName = atlheteInfoSave.FirstName,&#10;                    Email = atlheteInfoSave.Email,&#10;                    Dni = atlheteInfoSave.Dni,&#10;                    LastName = atlheteInfoSave.LastName,&#10;                    Address = atlheteInfoSave.Address,&#10;                    Seniority = atlheteInfoSave.Seniority,&#10;                    Status = atlheteInfoSave.Status,&#10;                    CreatedAt = DateTime.Now,&#10;                    Password = passwordHash,&#10;                };&#10;&#10;                await context.Users.AddAsync(user);&#10;                await context.SaveChangesAsync();&#10;&#10;                var athlete = new UserRol&#10;                {&#10;                    RolId = 3,&#10;                    UserId = user.UserId&#10;                };&#10;&#10;                await context.UserRoles.AddAsync(athlete);&#10;                await context.SaveChangesAsync();&#10;&#10;                return ResponseContract&lt;int&gt;.Ok(user.UserId, &quot;Atleta registrado exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en RegistrarAtleta: {ex.Message}&quot;);&#10;                return ResponseContract&lt;int&gt;.Fail($&quot;Error al registrar atleta: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;ValidateEmailDto&gt;&gt; ValidateEmail(ValidateEmailDto email)&#10;        {&#10;            try&#10;            {&#10;                var isAvailable = await GetUserByEmailAsync(email.Email);&#10;&#10;                if (isAvailable != null)&#10;                    return ResponseContract&lt;ValidateEmailDto&gt;.Ok(&#10;                        new ValidateEmailDto { Email = &quot;No disponible&quot; }, &#10;                        &quot;Email no disponible&quot;&#10;                    );&#10;&#10;                return ResponseContract&lt;ValidateEmailDto&gt;.Ok(&#10;                    new ValidateEmailDto { Email = email.Email }, &#10;                    &quot;Email disponible&quot;&#10;                );&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en ValidateEmail: {ex.Message}&quot;);&#10;                return ResponseContract&lt;ValidateEmailDto&gt;.Fail($&quot;Error al validar email: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        /// &lt;summary&gt;&#10;        /// Método para la busqueda de los atletas por nombre&#10;        /// &lt;/summary&gt;&#10;        /// &lt;param name=&quot;user&quot;&gt;&lt;/param&gt;&#10;        /// &lt;returns&gt;&lt;/returns&gt;&#10;        public async Task&lt;ResponseContract&lt;List&lt;User&gt;&gt;&gt; GetUserForName(SearchDataAthleteDto user)&#10;        {&#10;            try&#10;            {&#10;                if (string.IsNullOrWhiteSpace(user?.FirstName))&#10;                    return ResponseContract&lt;List&lt;User&gt;&gt;.Fail(&quot;Debe proporcionar un nombre para la búsqueda.&quot;);&#10;&#10;                var userInfo = await (from u in context.Users&#10;                        join tu in context.TeamsUsers on u.UserId equals tu.UserId&#10;                        join ur in context.UserRoles on u.UserId equals ur.UserId&#10;                        where u.FirstName != null&#10;                              &amp;&amp; EF.Functions.Like(u.FirstName, $&quot;%{user.FirstName}%&quot;)&#10;                              &amp;&amp; tu.TeamId == user.TeamId&#10;                              &amp;&amp; ur.RolId == 3&#10;                        select u)&#10;                    .Distinct()&#10;                    .ToListAsync();&#10;&#10;&#10;                return ResponseContract&lt;List&lt;User&gt;&gt;.Ok(userInfo, &quot;Búsqueda realizada satisfactoriamente&quot;);&#10;            }&#10;            catch (Exception e)&#10;            {&#10;                Console.WriteLine(e);&#10;                return ResponseContract&lt;List&lt;User&gt;&gt;.Fail(&quot;Ocurrió un error realizando la búsqueda&quot;);&#10;            }&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="﻿using BocciaCoaching.Data;&#10;using BocciaCoaching.Models.DTO.Auth;&#10;using BocciaCoaching.Models.DTO.General;&#10;using BocciaCoaching.Models.DTO.User;&#10;using BocciaCoaching.Models.DTO.User.Atlhete;&#10;using BocciaCoaching.Models.Entities;&#10;using BocciaCoaching.Repositories.Interfaces;&#10;using Microsoft.EntityFrameworkCore;&#10;&#10;namespace BocciaCoaching.Repositories&#10;{&#10;    public class UserRepository(ApplicationDbContext context) : IUserRepository&#10;    {&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; AddUser(InfoUserRegisterDto userDto)&#10;        {&#10;            try&#10;            {&#10;                string passwordHash = BCrypt.Net.BCrypt.HashPassword(userDto.Password);&#10;&#10;                var user = new User&#10;                {&#10;                    Email = userDto.Email,&#10;                    Password = passwordHash,&#10;                    Country = userDto.Region,&#10;                    FirstName = &quot;Name&quot;,&#10;                };&#10;&#10;                await context.Users.AddAsync(user);&#10;                await context.SaveChangesAsync();&#10;&#10;                var athlete = new UserRol&#10;                {&#10;                    RolId = userDto.Rol,&#10;                    UserId = user.UserId&#10;                };&#10;&#10;                await context.UserRoles.AddAsync(athlete);&#10;                await context.SaveChangesAsync();&#10;&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Usuario creado exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en AddUser: {ex.Message}&quot;);&#10;                return ResponseContract&lt;bool&gt;.Fail($&quot;Error al crear usuario: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;IEnumerable&lt;InfoBasicUserDto&gt;&gt;&gt; GetAllAsync()&#10;        {&#10;            try&#10;            {&#10;                var usersData = await context.Users.ToListAsync();&#10;                var infoUser = usersData.Select(u =&gt; new InfoBasicUserDto&#10;                {&#10;                    Name = u.FirstName&#10;                }).ToList();&#10;&#10;                return ResponseContract&lt;IEnumerable&lt;InfoBasicUserDto&gt;&gt;.Ok(infoUser, &quot;Usuarios obtenidos exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en GetAllAsync: {ex.Message}&quot;);&#10;                return ResponseContract&lt;IEnumerable&lt;InfoBasicUserDto&gt;&gt;.Fail($&quot;Error al obtener usuarios: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;InfoBasicUserDto&gt;&gt; GetByIdAsync(int id)&#10;        {&#10;            try&#10;            {&#10;                var user = await context.Users.FindAsync(id);&#10;                &#10;                if (user == null)&#10;                    return ResponseContract&lt;InfoBasicUserDto&gt;.Fail(&quot;Usuario no encontrado&quot;);&#10;&#10;                var infoUser = new InfoBasicUserDto&#10;                {&#10;                    Name = user.FirstName&#10;                };&#10;&#10;                return ResponseContract&lt;InfoBasicUserDto&gt;.Ok(infoUser, &quot;Usuario obtenido exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en GetByIdAsync: {ex.Message}&quot;);&#10;                return ResponseContract&lt;InfoBasicUserDto&gt;.Fail($&quot;Error al obtener usuario: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        private async Task&lt;User?&gt; GetUserByEmailAsync(string email)&#10;        {&#10;            return await context.Users&#10;                .Select(u =&gt; new User&#10;                {&#10;                    UserId = u.UserId,&#10;                    Dni = u.Dni,&#10;                    FirstName = u.FirstName ?? string.Empty,&#10;                    LastName = u.LastName ?? string.Empty,&#10;                    Email = u.Email ?? string.Empty,&#10;                    Password = u.Password ?? string.Empty,&#10;                    Address = u.Address,&#10;                    Country = u.Country,&#10;                    Image = u.Image,&#10;                    Category = u.Category,&#10;                    Seniority = u.Seniority,&#10;                    Status = u.Status,&#10;                    CreatedAt = u.CreatedAt,&#10;                    UpdatedAt = u.UpdatedAt&#10;                })&#10;                .FirstOrDefaultAsync(u =&gt; u.Email == email);&#10;        }&#10;&#10;        /// &lt;summary&gt;&#10;        /// Método para iniciar sesión &#10;        /// &lt;/summary&gt;&#10;        /// &lt;returns&gt;&lt;/returns&gt;&#10;        public async Task&lt;ResponseContract&lt;LoginResponseDto&gt;&gt; Login(LoginRequestDto loginDto)&#10;        {&#10;            try&#10;            {&#10;                var user = await GetUserByEmailAsync(loginDto.Email);&#10;                if (user == null) &#10;                    return ResponseContract&lt;LoginResponseDto&gt;.Fail(&quot;Usuario no encontrado&quot;);&#10;&#10;                // Verificar contraseña&#10;                bool validPassword = BCrypt.Net.BCrypt.Verify(loginDto.Password, user.Password);&#10;                if (!validPassword) &#10;                    return ResponseContract&lt;LoginResponseDto&gt;.Fail(&quot;Contraseña incorrecta&quot;);&#10;&#10;                var roles = context.UserRoles.Where(x =&gt; x.UserId == user.UserId).ToList();&#10;&#10;                if (roles.Count == 0)&#10;                    return ResponseContract&lt;LoginResponseDto&gt;.Fail(&quot;Usuario sin roles asignados&quot;);&#10;&#10;                // Generar respuesta&#10;                var response = new LoginResponseDto&#10;                {&#10;                    UserId = user.UserId,&#10;                    Dni = user.Dni,&#10;                    FirstName = user.FirstName,&#10;                    LastName = user.LastName,&#10;                    Email = user.Email,&#10;                    Address = user.Address,&#10;                    Country = user.Country,&#10;                    Image = user.Image,&#10;                    Category = user.Category,&#10;                    Seniority = user.Seniority,&#10;                    Status = user.Status,&#10;                    RolId = roles[0].RolId,&#10;                    CreatedAt = user.CreatedAt,&#10;                    UpdatedAt = user.UpdatedAt&#10;                };&#10;&#10;                return ResponseContract&lt;LoginResponseDto&gt;.Ok(response, &quot;Login exitoso&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en Login: {ex.Message}&quot;);&#10;                return ResponseContract&lt;LoginResponseDto&gt;.Fail($&quot;Error al iniciar sesión: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        /// &lt;summary&gt;&#10;        /// Registrar atleta&#10;        /// &lt;/summary&gt;&#10;        /// &lt;param name=&quot;atlheteInfoSave&quot;&gt;&lt;/param&gt;&#10;        /// &lt;returns&gt;&lt;/returns&gt;&#10;        public async Task&lt;ResponseContract&lt;int&gt;&gt; RegistrarAtleta(AtlheteInfoSave atlheteInfoSave)&#10;        {&#10;            try&#10;            {&#10;                // Contraseña por defecto&#10;                string defaultPassword = &quot;boccia123&quot;;&#10;                string passwordHash = BCrypt.Net.BCrypt.HashPassword(defaultPassword);&#10;&#10;                var user = new User&#10;                {&#10;                    FirstName = atlheteInfoSave.FirstName,&#10;                    Email = atlheteInfoSave.Email,&#10;                    Dni = atlheteInfoSave.Dni,&#10;                    LastName = atlheteInfoSave.LastName,&#10;                    Address = atlheteInfoSave.Address,&#10;                    Seniority = atlheteInfoSave.Seniority,&#10;                    Status = atlheteInfoSave.Status,&#10;                    CreatedAt = DateTime.Now,&#10;                    Password = passwordHash,&#10;                };&#10;&#10;                await context.Users.AddAsync(user);&#10;                await context.SaveChangesAsync();&#10;&#10;                var athlete = new UserRol&#10;                {&#10;                    RolId = 3,&#10;                    UserId = user.UserId&#10;                };&#10;&#10;                await context.UserRoles.AddAsync(athlete);&#10;                await context.SaveChangesAsync();&#10;&#10;                return ResponseContract&lt;int&gt;.Ok(user.UserId, &quot;Atleta registrado exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en RegistrarAtleta: {ex.Message}&quot;);&#10;                return ResponseContract&lt;int&gt;.Fail($&quot;Error al registrar atleta: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;ValidateEmailDto&gt;&gt; ValidateEmail(ValidateEmailDto email)&#10;        {&#10;            try&#10;            {&#10;                var isAvailable = await GetUserByEmailAsync(email.Email);&#10;&#10;                if (isAvailable != null)&#10;                    return ResponseContract&lt;ValidateEmailDto&gt;.Ok(&#10;                        new ValidateEmailDto { Email = &quot;No disponible&quot; }, &#10;                        &quot;Email no disponible&quot;&#10;                    );&#10;&#10;                return ResponseContract&lt;ValidateEmailDto&gt;.Ok(&#10;                    new ValidateEmailDto { Email = email.Email }, &#10;                    &quot;Email disponible&quot;&#10;                );&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en ValidateEmail: {ex.Message}&quot;);&#10;                return ResponseContract&lt;ValidateEmailDto&gt;.Fail($&quot;Error al validar email: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        /// &lt;summary&gt;&#10;        /// Método para la busqueda de los atletas por nombre&#10;        /// &lt;/summary&gt;&#10;        /// &lt;param name=&quot;user&quot;&gt;&lt;/param&gt;&#10;        /// &lt;returns&gt;&lt;/returns&gt;&#10;        public async Task&lt;ResponseContract&lt;List&lt;User&gt;&gt;&gt; GetUserForName(SearchDataAthleteDto user)&#10;        {&#10;            try&#10;            {&#10;                if (string.IsNullOrWhiteSpace(user?.FirstName))&#10;                    return ResponseContract&lt;List&lt;User&gt;&gt;.Fail(&quot;Debe proporcionar un nombre para la búsqueda.&quot;);&#10;&#10;                var userInfo = await (from u in context.Users&#10;                        join tu in context.TeamsUsers on u.UserId equals tu.UserId&#10;                        join ur in context.UserRoles on u.UserId equals ur.UserId&#10;                        where u.FirstName != null&#10;                              &amp;&amp; EF.Functions.Like(u.FirstName, $&quot;%{user.FirstName}%&quot;)&#10;                              &amp;&amp; tu.TeamId == user.TeamId&#10;                              &amp;&amp; ur.RolId == 3&#10;                        select u)&#10;                    .Distinct()&#10;                    .ToListAsync();&#10;&#10;&#10;                return ResponseContract&lt;List&lt;User&gt;&gt;.Ok(userInfo, &quot;Búsqueda realizada satisfactoriamente&quot;);&#10;            }&#10;            catch (Exception e)&#10;            {&#10;                Console.WriteLine(e);&#10;                return ResponseContract&lt;List&lt;User&gt;&gt;.Fail(&quot;Ocurrió un error realizando la búsqueda&quot;);&#10;            }&#10;        }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>