<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/BocciaCoaching/Services/NotificationService.cs">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/BocciaCoaching/Services/NotificationService.cs" />
              <option name="originalContent" value="using BocciaCoaching.Models.Entities;&#10;using BocciaCoaching.Models.DTO.General;&#10;using BocciaCoaching.Models.DTO.Notification;&#10;using BocciaCoaching.Repositories.NotificationTypes;&#10;using BocciaCoaching.Repositories.Interfaces;&#10;using BocciaCoaching.Services.Interfaces;&#10;&#10;namespace BocciaCoaching.Services&#10;{&#10;    public class NotificationService : INotificationService&#10;    {&#10;        private readonly INotificationTypeRepository _repo;&#10;        private readonly IUserRepository _userRepo;&#10;&#10;        public NotificationService(INotificationTypeRepository repo, IUserRepository userRepo)&#10;        {&#10;            _repo = repo;&#10;            _userRepo = userRepo;&#10;        }&#10;&#10;        private NotificationTypeDto MapType(NotificationType t)&#10;        {&#10;            return new NotificationTypeDto&#10;            {&#10;                NotificationTypeId = t.NotificationTypeId,&#10;                Name = t.Name,&#10;                Description = t.Description,&#10;                Status = t.Status,&#10;                CreatedAt = t.CreatedAt,&#10;                UpdatedAt = t.UpdatedAt&#10;            };&#10;        }&#10;&#10;        private NotificationMessageDto MapMessage(NotificationMessage m)&#10;        {&#10;            return new NotificationMessageDto&#10;            {&#10;                NotificationMessageId = m.NotificationMessageId,&#10;                Message = m.Message,&#10;                Image = m.Image,&#10;                CoachId = m.CoachId,&#10;                // La entidad User tiene FirstName/LastName&#10;                CoachName = m.Coach.FirstName != null ? (m.Coach.FirstName + (string.IsNullOrWhiteSpace(m.Coach.LastName) ? &quot;&quot; : &quot; &quot; + m.Coach.LastName)) : null,&#10;                AthleteId = m.AthleteId,&#10;                AthleteName = m.Athlete.FirstName != null ? (m.Athlete.FirstName + (string.IsNullOrWhiteSpace(m.Athlete.LastName) ? &quot;&quot; : &quot; &quot; + m.Athlete.LastName)) : null,&#10;                NotificationTypeId = m.NotificationTypeId,&#10;                NotificationTypeName = m.NotificationType.Name,&#10;                Status = m.Status&#10;            };&#10;        }&#10;&#10;        private async Task&lt;NotificationMessageDto&gt; MapMessageAsync(NotificationMessage m)&#10;        {&#10;            var dto = MapMessage(m);&#10;&#10;            if (string.IsNullOrWhiteSpace(dto.CoachName))&#10;            {&#10;                var coachResponse = await _userRepo.GetByIdAsync(m.CoachId);&#10;                if (coachResponse.Success &amp;&amp; coachResponse.Data != null)&#10;                {&#10;                    var firstName = coachResponse.Data.Name ?? string.Empty;&#10;                    var lastName = coachResponse.Data.LastName;&#10;                    dto.CoachName = string.IsNullOrWhiteSpace(lastName) &#10;                        ? firstName.Trim() &#10;                        : (firstName + &quot; &quot; + lastName).Trim();&#10;                }&#10;            }&#10;&#10;            if (string.IsNullOrWhiteSpace(dto.AthleteName))&#10;            {&#10;                var athleteResponse = await _userRepo.GetByIdAsync(m.AthleteId);&#10;                if (athleteResponse.Success &amp;&amp; athleteResponse.Data != null)&#10;                {&#10;                    var firstName = athleteResponse.Data.Name ?? string.Empty;&#10;                    var lastName = athleteResponse.Data.LastName;&#10;                    dto.AthleteName = string.IsNullOrWhiteSpace(lastName) &#10;                        ? firstName.Trim() &#10;                        : (firstName + &quot; &quot; + lastName).Trim();&#10;                }&#10;            }&#10;&#10;            if (string.IsNullOrWhiteSpace(dto.NotificationTypeName))&#10;            {&#10;                var nt = await _repo.GetByIdAsync(m.NotificationTypeId);&#10;                dto.NotificationTypeName = nt?.Name;&#10;            }&#10;&#10;            return dto;&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;IEnumerable&lt;NotificationTypeDto&gt;&gt;&gt; GetAllTypes()&#10;        {&#10;            try&#10;            {&#10;                var types = await _repo.GetAllAsync();&#10;                var dto = types.Select(MapType).ToList();&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationTypeDto&gt;&gt;.Ok(dto);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationTypeDto&gt;&gt;.Fail(&quot;Error obteniendo los tipos de notificación&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;NotificationTypeDto&gt;&gt; GetTypeById(int id)&#10;        {&#10;            try&#10;            {&#10;                var type = await _repo.GetByIdAsync(id);&#10;                if (type == null) return ResponseContract&lt;NotificationTypeDto&gt;.Fail(&quot;Tipo no encontrado&quot;);&#10;&#10;                return ResponseContract&lt;NotificationTypeDto&gt;.Ok(MapType(type));&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;NotificationTypeDto&gt;.Fail(&quot;Error obteniendo el tipo de notificación&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; CreateType(RequestCreateNotificationTypeDto? typeDto)&#10;        {&#10;            try&#10;            {&#10;                if (string.IsNullOrWhiteSpace(typeDto?.Name))&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;El nombre del tipo es requerido&quot;);&#10;&#10;                var type = new NotificationType&#10;                {&#10;                    Name = typeDto.Name,&#10;                    Description = typeDto.Description,&#10;                    Status = true,&#10;                    CreatedAt = DateTime.Now&#10;                };&#10;&#10;                var result = await _repo.AddAsync(type);&#10;                if (!result) return ResponseContract&lt;bool&gt;.Fail(&quot;No se pudo crear el tipo&quot;);&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Tipo creado&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;bool&gt;.Fail(&quot;Error creando el tipo&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; UpdateType(RequestUpdateNotificationTypeDto? typeDto)&#10;        {&#10;            try&#10;            {&#10;                if (typeDto is null || typeDto.NotificationTypeId &lt;= 0)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Tipo inválido&quot;);&#10;&#10;                if (string.IsNullOrWhiteSpace(typeDto.Name))&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;El nombre del tipo es requerido&quot;);&#10;&#10;                var type = new NotificationType&#10;                {&#10;                    NotificationTypeId = typeDto.NotificationTypeId,&#10;                    Name = typeDto.Name,&#10;                    Description = typeDto.Description,&#10;                    Status = typeDto.Status&#10;                };&#10;&#10;                var result = await _repo.UpdateAsync(type);&#10;                if (!result) return ResponseContract&lt;bool&gt;.Fail(&quot;No se pudo actualizar el tipo&quot;);&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Tipo actualizado&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;bool&gt;.Fail(&quot;Error actualizando el tipo&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;NotificationMessageDto&gt;&gt; GetMessageById(int id)&#10;        {&#10;            try&#10;            {&#10;                var message = await _repo.GetMessageByIdAsync(id);&#10;                if (message == null) return ResponseContract&lt;NotificationMessageDto&gt;.Fail(&quot;Mensaje no encontrado&quot;);&#10;                var dto = await MapMessageAsync(message);&#10;                return ResponseContract&lt;NotificationMessageDto&gt;.Ok(dto);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;NotificationMessageDto&gt;.Fail(&quot;Error obteniendo el mensaje&quot;);&#10;            }&#10;        }&#10;&#10;        private async Task&lt;(bool exists, string? name)&gt; GetUserInfo(int userId)&#10;        {&#10;            var userResponse = await _userRepo.GetByIdAsync(userId);&#10;            &#10;            if (!userResponse.Success || userResponse.Data == null) &#10;                return (false, null);&#10;            &#10;            var first = userResponse.Data.Name ?? string.Empty;&#10;            var last = userResponse.Data.LastName;&#10;            var fullName = string.IsNullOrWhiteSpace(last) ? first.Trim() : (first + &quot; &quot; + last).Trim();&#10;            return (true, string.IsNullOrWhiteSpace(fullName) ? null : fullName);&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; CreateMessage(RequestCreateNotificationMessageDto? messageDto)&#10;        {&#10;            try&#10;            {&#10;                if (messageDto is null)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Mensaje inválido&quot;);&#10;&#10;                // Validar que exista el tipo de notificación&#10;                var type = await _repo.GetByIdAsync(messageDto.NotificationTypeId);&#10;                if (type == null)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Tipo de notificación inválido&quot;);&#10;&#10;                // Validar coach y athlete&#10;                var (coachExists, _) = await GetUserInfo(messageDto.CoachId);&#10;                if (!coachExists) return ResponseContract&lt;bool&gt;.Fail(&quot;Coach inválido&quot;);&#10;                var (athleteExists, _) = await GetUserInfo(messageDto.AthleteId);&#10;                if (!athleteExists) return ResponseContract&lt;bool&gt;.Fail(&quot;Atleta inválido&quot;);&#10;&#10;                var message = new NotificationMessage&#10;                {&#10;                    Message = messageDto.Message,&#10;                    Image = messageDto.Image,&#10;                    CoachId = messageDto.CoachId,&#10;                    AthleteId = messageDto.AthleteId,&#10;                    NotificationTypeId = messageDto.NotificationTypeId,&#10;                    Status = messageDto.Status&#10;                };&#10;&#10;                var result = await _repo.AddMessageAsync(message);&#10;                if (!result) return ResponseContract&lt;bool&gt;.Fail(&quot;No se pudo crear el mensaje&quot;);&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Mensaje creado&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;bool&gt;.Fail(&quot;Error creando el mensaje&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; UpdateMessage(RequestUpdateNotificationMessageDto? messageDto)&#10;        {&#10;            try&#10;            {&#10;                if (messageDto is null || messageDto.NotificationMessageId &lt;= 0)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Mensaje inválido&quot;);&#10;&#10;                // Validar que exista el tipo de notificación&#10;                var type = await _repo.GetByIdAsync(messageDto.NotificationTypeId);&#10;                if (type == null)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Tipo de notificación inválido&quot;);&#10;&#10;                var (coachExists, _) = await GetUserInfo(messageDto.CoachId);&#10;                if (!coachExists) return ResponseContract&lt;bool&gt;.Fail(&quot;Coach inválido&quot;);&#10;                var (athleteExists, _) = await GetUserInfo(messageDto.AthleteId);&#10;                if (!athleteExists) return ResponseContract&lt;bool&gt;.Fail(&quot;Atleta inválido&quot;);&#10;&#10;                var message = new NotificationMessage&#10;                {&#10;                    NotificationMessageId = messageDto.NotificationMessageId,&#10;                    Message = messageDto.Message,&#10;                    Image = messageDto.Image,&#10;                    CoachId = messageDto.CoachId,&#10;                    AthleteId = messageDto.AthleteId,&#10;                    NotificationTypeId = messageDto.NotificationTypeId,&#10;                    Status = messageDto.Status&#10;                };&#10;&#10;                var result = await _repo.UpdateMessageAsync(message);&#10;                if (!result) return ResponseContract&lt;bool&gt;.Fail(&quot;No se pudo actualizar el mensaje&quot;);&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Mensaje actualizado&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;bool&gt;.Fail(&quot;Error actualizando el mensaje&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;&gt; GetMessagesByCoach(int coachId, int? page = null, int? pageSize = null, bool? status = null)&#10;        {&#10;            try&#10;            {&#10;                var messages = await _repo.GetMessagesByCoachAsync(coachId);&#10;                var query = messages.AsQueryable();&#10;                if (status.HasValue) query = query.Where(m =&gt; m.Status == status.Value);&#10;&#10;                if (page.HasValue &amp;&amp; pageSize.HasValue &amp;&amp; page &gt; 0 &amp;&amp; pageSize &gt; 0)&#10;                {&#10;                    query = query.Skip((page.Value - 1) * pageSize.Value).Take(pageSize.Value);&#10;                }&#10;&#10;                var tasks = query.Select(m =&gt; MapMessageAsync(m)).ToList();&#10;                var dtoArray = await Task.WhenAll(tasks);&#10;                var dto = dtoArray.ToList();&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;.Ok(dto);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;.Fail(&quot;Error obteniendo mensajes por coach&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;&gt; GetMessagesByAthlete(int athleteId, int? page = null, int? pageSize = null, bool? status = null)&#10;        {&#10;            try&#10;            {&#10;                var messages = await _repo.GetMessagesByAthleteAsync(athleteId);&#10;                var query = messages.AsQueryable();&#10;             //  if (status.HasValue) query = query.Where(m =&gt; m.Status == status.Value);&#10;&#10;                if (page.HasValue &amp;&amp; pageSize.HasValue &amp;&amp; page &gt; 0 &amp;&amp; pageSize &gt; 0)&#10;                {&#10;                    query = query.Skip((page.Value - 1) * pageSize.Value).Take(pageSize.Value);&#10;                }&#10;&#10;                var tasks = query.Select(m =&gt; MapMessageAsync(m)).ToList();&#10;                var dtoArray = await Task.WhenAll(tasks);&#10;                var dto = dtoArray.ToList();&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;.Ok(dto);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;.Fail(&quot;Error obteniendo mensajes por atleta&quot;);&#10;            }&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="using BocciaCoaching.Models.Entities;&#10;using BocciaCoaching.Models.DTO.General;&#10;using BocciaCoaching.Models.DTO.Notification;&#10;using BocciaCoaching.Repositories.NotificationTypes;&#10;using BocciaCoaching.Repositories.Interfaces;&#10;using BocciaCoaching.Services.Interfaces;&#10;&#10;namespace BocciaCoaching.Services&#10;{&#10;    public class NotificationService : INotificationService&#10;    {&#10;        private readonly INotificationTypeRepository _repo;&#10;        private readonly IUserRepository _userRepo;&#10;&#10;        public NotificationService(INotificationTypeRepository repo, IUserRepository userRepo)&#10;        {&#10;            _repo = repo;&#10;            _userRepo = userRepo;&#10;        }&#10;&#10;        private NotificationTypeDto MapType(NotificationType t)&#10;        {&#10;            return new NotificationTypeDto&#10;            {&#10;                NotificationTypeId = t.NotificationTypeId,&#10;                Name = t.Name,&#10;                Description = t.Description,&#10;                Status = t.Status,&#10;                CreatedAt = t.CreatedAt,&#10;                UpdatedAt = t.UpdatedAt&#10;            };&#10;        }&#10;&#10;        private NotificationMessageDto MapMessage(NotificationMessage m)&#10;        {&#10;            return new NotificationMessageDto&#10;            {&#10;                NotificationMessageId = m.NotificationMessageId,&#10;                Message = m.Message,&#10;                Image = m.Image,&#10;                CoachId = m.CoachId,&#10;                // Manejo seguro de propiedades de navegación&#10;                CoachName = m.Coach != null &amp;&amp; m.Coach.FirstName != null &#10;                    ? (m.Coach.FirstName + (string.IsNullOrWhiteSpace(m.Coach.LastName) ? &quot;&quot; : &quot; &quot; + m.Coach.LastName)) &#10;                    : null,&#10;                AthleteId = m.AthleteId,&#10;                AthleteName = m.Athlete != null &amp;&amp; m.Athlete.FirstName != null &#10;                    ? (m.Athlete.FirstName + (string.IsNullOrWhiteSpace(m.Athlete.LastName) ? &quot;&quot; : &quot; &quot; + m.Athlete.LastName)) &#10;                    : null,&#10;                NotificationTypeId = m.NotificationTypeId,&#10;                NotificationTypeName = m.NotificationType?.Name,&#10;                Status = m.Status&#10;            };&#10;        }&#10;&#10;        private async Task&lt;NotificationMessageDto&gt; MapMessageAsync(NotificationMessage m)&#10;        {&#10;            var dto = MapMessage(m);&#10;&#10;            if (string.IsNullOrWhiteSpace(dto.CoachName))&#10;            {&#10;                var coachResponse = await _userRepo.GetByIdAsync(m.CoachId);&#10;                if (coachResponse.Success &amp;&amp; coachResponse.Data != null)&#10;                {&#10;                    var firstName = coachResponse.Data.Name ?? string.Empty;&#10;                    var lastName = coachResponse.Data.LastName;&#10;                    dto.CoachName = string.IsNullOrWhiteSpace(lastName) &#10;                        ? firstName.Trim() &#10;                        : (firstName + &quot; &quot; + lastName).Trim();&#10;                }&#10;            }&#10;&#10;            if (string.IsNullOrWhiteSpace(dto.AthleteName))&#10;            {&#10;                var athleteResponse = await _userRepo.GetByIdAsync(m.AthleteId);&#10;                if (athleteResponse.Success &amp;&amp; athleteResponse.Data != null)&#10;                {&#10;                    var firstName = athleteResponse.Data.Name ?? string.Empty;&#10;                    var lastName = athleteResponse.Data.LastName;&#10;                    dto.AthleteName = string.IsNullOrWhiteSpace(lastName) &#10;                        ? firstName.Trim() &#10;                        : (firstName + &quot; &quot; + lastName).Trim();&#10;                }&#10;            }&#10;&#10;            if (string.IsNullOrWhiteSpace(dto.NotificationTypeName))&#10;            {&#10;                var nt = await _repo.GetByIdAsync(m.NotificationTypeId);&#10;                dto.NotificationTypeName = nt?.Name;&#10;            }&#10;&#10;            return dto;&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;IEnumerable&lt;NotificationTypeDto&gt;&gt;&gt; GetAllTypes()&#10;        {&#10;            try&#10;            {&#10;                var types = await _repo.GetAllAsync();&#10;                var dto = types.Select(MapType).ToList();&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationTypeDto&gt;&gt;.Ok(dto);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationTypeDto&gt;&gt;.Fail(&quot;Error obteniendo los tipos de notificación&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;NotificationTypeDto&gt;&gt; GetTypeById(int id)&#10;        {&#10;            try&#10;            {&#10;                var type = await _repo.GetByIdAsync(id);&#10;                if (type == null) return ResponseContract&lt;NotificationTypeDto&gt;.Fail(&quot;Tipo no encontrado&quot;);&#10;&#10;                return ResponseContract&lt;NotificationTypeDto&gt;.Ok(MapType(type));&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;NotificationTypeDto&gt;.Fail(&quot;Error obteniendo el tipo de notificación&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; CreateType(RequestCreateNotificationTypeDto? typeDto)&#10;        {&#10;            try&#10;            {&#10;                if (string.IsNullOrWhiteSpace(typeDto?.Name))&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;El nombre del tipo es requerido&quot;);&#10;&#10;                var type = new NotificationType&#10;                {&#10;                    Name = typeDto.Name,&#10;                    Description = typeDto.Description,&#10;                    Status = true,&#10;                    CreatedAt = DateTime.Now&#10;                };&#10;&#10;                var result = await _repo.AddAsync(type);&#10;                if (!result) return ResponseContract&lt;bool&gt;.Fail(&quot;No se pudo crear el tipo&quot;);&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Tipo creado&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;bool&gt;.Fail(&quot;Error creando el tipo&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; UpdateType(RequestUpdateNotificationTypeDto? typeDto)&#10;        {&#10;            try&#10;            {&#10;                if (typeDto is null || typeDto.NotificationTypeId &lt;= 0)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Tipo inválido&quot;);&#10;&#10;                if (string.IsNullOrWhiteSpace(typeDto.Name))&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;El nombre del tipo es requerido&quot;);&#10;&#10;                var type = new NotificationType&#10;                {&#10;                    NotificationTypeId = typeDto.NotificationTypeId,&#10;                    Name = typeDto.Name,&#10;                    Description = typeDto.Description,&#10;                    Status = typeDto.Status&#10;                };&#10;&#10;                var result = await _repo.UpdateAsync(type);&#10;                if (!result) return ResponseContract&lt;bool&gt;.Fail(&quot;No se pudo actualizar el tipo&quot;);&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Tipo actualizado&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;bool&gt;.Fail(&quot;Error actualizando el tipo&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;NotificationMessageDto&gt;&gt; GetMessageById(int id)&#10;        {&#10;            try&#10;            {&#10;                var message = await _repo.GetMessageByIdAsync(id);&#10;                if (message == null) return ResponseContract&lt;NotificationMessageDto&gt;.Fail(&quot;Mensaje no encontrado&quot;);&#10;                var dto = await MapMessageAsync(message);&#10;                return ResponseContract&lt;NotificationMessageDto&gt;.Ok(dto);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;NotificationMessageDto&gt;.Fail(&quot;Error obteniendo el mensaje&quot;);&#10;            }&#10;        }&#10;&#10;        private async Task&lt;(bool exists, string? name)&gt; GetUserInfo(int userId)&#10;        {&#10;            var userResponse = await _userRepo.GetByIdAsync(userId);&#10;            &#10;            if (!userResponse.Success || userResponse.Data == null) &#10;                return (false, null);&#10;            &#10;            var first = userResponse.Data.Name ?? string.Empty;&#10;            var last = userResponse.Data.LastName;&#10;            var fullName = string.IsNullOrWhiteSpace(last) ? first.Trim() : (first + &quot; &quot; + last).Trim();&#10;            return (true, string.IsNullOrWhiteSpace(fullName) ? null : fullName);&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; CreateMessage(RequestCreateNotificationMessageDto? messageDto)&#10;        {&#10;            try&#10;            {&#10;                if (messageDto is null)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Mensaje inválido&quot;);&#10;&#10;                // Validar que exista el tipo de notificación&#10;                var type = await _repo.GetByIdAsync(messageDto.NotificationTypeId);&#10;                if (type == null)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Tipo de notificación inválido&quot;);&#10;&#10;                // Validar coach y athlete&#10;                var (coachExists, _) = await GetUserInfo(messageDto.CoachId);&#10;                if (!coachExists) return ResponseContract&lt;bool&gt;.Fail(&quot;Coach inválido&quot;);&#10;                var (athleteExists, _) = await GetUserInfo(messageDto.AthleteId);&#10;                if (!athleteExists) return ResponseContract&lt;bool&gt;.Fail(&quot;Atleta inválido&quot;);&#10;&#10;                var message = new NotificationMessage&#10;                {&#10;                    Message = messageDto.Message,&#10;                    Image = messageDto.Image,&#10;                    CoachId = messageDto.CoachId,&#10;                    AthleteId = messageDto.AthleteId,&#10;                    NotificationTypeId = messageDto.NotificationTypeId,&#10;                    Status = messageDto.Status&#10;                };&#10;&#10;                var result = await _repo.AddMessageAsync(message);&#10;                if (!result) return ResponseContract&lt;bool&gt;.Fail(&quot;No se pudo crear el mensaje&quot;);&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Mensaje creado&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;bool&gt;.Fail(&quot;Error creando el mensaje&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;bool&gt;&gt; UpdateMessage(RequestUpdateNotificationMessageDto? messageDto)&#10;        {&#10;            try&#10;            {&#10;                if (messageDto is null || messageDto.NotificationMessageId &lt;= 0)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Mensaje inválido&quot;);&#10;&#10;                // Validar que exista el tipo de notificación&#10;                var type = await _repo.GetByIdAsync(messageDto.NotificationTypeId);&#10;                if (type == null)&#10;                    return ResponseContract&lt;bool&gt;.Fail(&quot;Tipo de notificación inválido&quot;);&#10;&#10;                var (coachExists, _) = await GetUserInfo(messageDto.CoachId);&#10;                if (!coachExists) return ResponseContract&lt;bool&gt;.Fail(&quot;Coach inválido&quot;);&#10;                var (athleteExists, _) = await GetUserInfo(messageDto.AthleteId);&#10;                if (!athleteExists) return ResponseContract&lt;bool&gt;.Fail(&quot;Atleta inválido&quot;);&#10;&#10;                var message = new NotificationMessage&#10;                {&#10;                    NotificationMessageId = messageDto.NotificationMessageId,&#10;                    Message = messageDto.Message,&#10;                    Image = messageDto.Image,&#10;                    CoachId = messageDto.CoachId,&#10;                    AthleteId = messageDto.AthleteId,&#10;                    NotificationTypeId = messageDto.NotificationTypeId,&#10;                    Status = messageDto.Status&#10;                };&#10;&#10;                var result = await _repo.UpdateMessageAsync(message);&#10;                if (!result) return ResponseContract&lt;bool&gt;.Fail(&quot;No se pudo actualizar el mensaje&quot;);&#10;                return ResponseContract&lt;bool&gt;.Ok(true, &quot;Mensaje actualizado&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine(ex.Message);&#10;                return ResponseContract&lt;bool&gt;.Fail(&quot;Error actualizando el mensaje&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;&gt; GetMessagesByCoach(int coachId, int? page = null, int? pageSize = null, bool? status = null)&#10;        {&#10;            try&#10;            {&#10;                var messages = await _repo.GetMessagesByCoachAsync(coachId);&#10;                var query = messages.AsQueryable();&#10;                if (status.HasValue) query = query.Where(m =&gt; m.Status == status.Value);&#10;&#10;                if (page.HasValue &amp;&amp; pageSize.HasValue &amp;&amp; page &gt; 0 &amp;&amp; pageSize &gt; 0)&#10;                {&#10;                    query = query.Skip((page.Value - 1) * pageSize.Value).Take(pageSize.Value);&#10;                }&#10;&#10;                var tasks = query.Select(m =&gt; MapMessageAsync(m)).ToList();&#10;                var dtoArray = await Task.WhenAll(tasks);&#10;                var dto = dtoArray.ToList();&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;.Ok(dto, &quot;Mensajes obtenidos exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en GetMessagesByCoach: {ex.Message}&quot;);&#10;                Console.WriteLine($&quot;StackTrace: {ex.StackTrace}&quot;);&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;.Fail($&quot;Error obteniendo mensajes por coach: {ex.Message}&quot;);&#10;            }&#10;        }&#10;&#10;        public async Task&lt;ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;&gt; GetMessagesByAthlete(int athleteId, int? page = null, int? pageSize = null, bool? status = null)&#10;        {&#10;            try&#10;            {&#10;                var messages = await _repo.GetMessagesByAthleteAsync(athleteId);&#10;                var query = messages.AsQueryable();&#10;             //  if (status.HasValue) query = query.Where(m =&gt; m.Status == status.Value);&#10;&#10;                if (page.HasValue &amp;&amp; pageSize.HasValue &amp;&amp; page &gt; 0 &amp;&amp; pageSize &gt; 0)&#10;                {&#10;                    query = query.Skip((page.Value - 1) * pageSize.Value).Take(pageSize.Value);&#10;                }&#10;&#10;                var tasks = query.Select(m =&gt; MapMessageAsync(m)).ToList();&#10;                var dtoArray = await Task.WhenAll(tasks);&#10;                var dto = dtoArray.ToList();&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;.Ok(dto, &quot;Mensajes obtenidos exitosamente&quot;);&#10;            }&#10;            catch (Exception ex)&#10;            {&#10;                Console.WriteLine($&quot;Error en GetMessagesByAthlete: {ex.Message}&quot;);&#10;                Console.WriteLine($&quot;StackTrace: {ex.StackTrace}&quot;);&#10;                return ResponseContract&lt;IEnumerable&lt;NotificationMessageDto&gt;&gt;.Fail($&quot;Error obteniendo mensajes por atleta: {ex.Message}&quot;);&#10;            }&#10;        }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>